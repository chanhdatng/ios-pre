---
import BaseLayout from '../components/layout/BaseLayout.astro';
import Sidebar from '../components/layout/Sidebar.astro';
import Header from '../components/layout/Header.astro';
import ReviewWithSearch from '../components/interactive/ReviewWithSearch';
import QuizRunner from '../components/interactive/QuizRunner';

// Load all flashcards - Core topics
import swiftFundamentals from '../data/flashcards/swift-fundamentals.json';
import iosCore from '../data/flashcards/ios-core.json';
import concurrency from '../data/flashcards/concurrency.json';
import swiftui from '../data/flashcards/swiftui.json';
import systemDesign from '../data/flashcards/system-design.json';
import behavioral from '../data/flashcards/behavioral.json';

// Load all flashcards - Advanced topics (NEW)
import modularArchitecture from '../data/flashcards/modular-architecture.json';
import offlineFirst from '../data/flashcards/offline-first.json';
import appLifecycle from '../data/flashcards/app-lifecycle.json';
import memoryManagement from '../data/flashcards/memory-management.json';
import productionReadiness from '../data/flashcards/production-readiness.json';
import architecturalPatterns from '../data/flashcards/architectural-patterns.json';
import visionos from '../data/flashcards/visionos.json';
import onDeviceMl from '../data/flashcards/on-device-ml.json';

// Load quiz data
import swiftQuiz from '../data/quizzes/swift-fundamentals-quiz.json';
import iosQuiz from '../data/quizzes/ios-core-quiz.json';
import concurrencyQuiz from '../data/quizzes/concurrency-quiz.json';
import swiftuiQuiz from '../data/quizzes/swiftui-quiz.json';

// Define topics - Core + Advanced
const topics = [
  // Core topics
  'Swift Fundamentals', 'iOS Core', 'Concurrency', 'SwiftUI', 'System Design', 'Behavioral',
  // Advanced topics (NEW)
  'Modular Architecture', 'Offline-First', 'App Lifecycle', 'Memory Management',
  'Production Readiness', 'Architectural Patterns', 'visionOS', 'On-Device ML'
];

// Combine all cards - Core topics
const allCards = [
  ...swiftFundamentals.cards.map(c => ({ ...c, topic: 'Swift Fundamentals' })),
  ...iosCore.cards.map(c => ({ ...c, topic: 'iOS Core' })),
  ...concurrency.cards.map(c => ({ ...c, topic: 'Concurrency' })),
  ...swiftui.cards.map(c => ({ ...c, topic: 'SwiftUI' })),
  ...systemDesign.cards.map(c => ({ ...c, topic: 'System Design' })),
  ...behavioral.cards.map(c => ({ ...c, topic: 'Behavioral' })),
  // Advanced topics (NEW)
  ...modularArchitecture.cards.map(c => ({ ...c, topic: 'Modular Architecture' })),
  ...offlineFirst.cards.map(c => ({ ...c, topic: 'Offline-First' })),
  ...appLifecycle.cards.map(c => ({ ...c, topic: 'App Lifecycle' })),
  ...memoryManagement.cards.map(c => ({ ...c, topic: 'Memory Management' })),
  ...productionReadiness.cards.map(c => ({ ...c, topic: 'Production Readiness' })),
  ...architecturalPatterns.cards.map(c => ({ ...c, topic: 'Architectural Patterns' })),
  ...visionos.cards.map(c => ({ ...c, topic: 'visionOS' })),
  ...onDeviceMl.cards.map(c => ({ ...c, topic: 'On-Device ML' })),
];

// Combine all quiz questions
const allQuestions = [
  ...swiftQuiz.questions,
  ...iosQuiz.questions,
  ...concurrencyQuiz.questions,
  ...swiftuiQuiz.questions,
];
---

<BaseLayout title="Review">
  <Sidebar slot="sidebar" />
  <Header title="Spaced Review" subtitle="Review cards due today" />

  <div class="space-y-6">
    <!-- Tab Navigation -->
    <div class="flex gap-2 border-b border-[var(--color-surface-secondary)]" id="review-tabs">
      <button
        class="tab-btn active px-4 py-2 text-body-small font-medium border-b-2 border-[var(--color-accent-orange)] text-[var(--color-accent-orange)]"
        data-tab="flashcards"
      >
        Flashcards ({allCards.length})
      </button>
      <button
        class="tab-btn px-4 py-2 text-body-small font-medium border-b-2 border-transparent text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]"
        data-tab="quiz"
      >
        Quiz ({allQuestions.length})
      </button>
    </div>

    <!-- Flashcards Tab -->
    <div id="flashcards-content" class="tab-content">
      <ReviewWithSearch allCards={allCards} topics={topics} client:load />
    </div>

    <!-- Quiz Tab -->
    <div id="quiz-content" class="tab-content hidden">
      <QuizRunner questions={allQuestions} client:load />
    </div>
  </div>
</BaseLayout>

<script>
  const tabs = document.querySelectorAll('.tab-btn');
  const flashcardsContent = document.getElementById('flashcards-content');
  const quizContent = document.getElementById('quiz-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Update tab styles
      tabs.forEach(t => {
        t.classList.remove('active', 'border-[var(--color-accent-orange)]', 'text-[var(--color-accent-orange)]');
        t.classList.add('border-transparent', 'text-[var(--color-text-secondary)]');
      });
      tab.classList.add('active', 'border-[var(--color-accent-orange)]', 'text-[var(--color-accent-orange)]');
      tab.classList.remove('border-transparent', 'text-[var(--color-text-secondary)]');

      // Show/hide content
      const tabName = tab.getAttribute('data-tab');
      if (tabName === 'flashcards') {
        flashcardsContent?.classList.remove('hidden');
        quizContent?.classList.add('hidden');
      } else {
        flashcardsContent?.classList.add('hidden');
        quizContent?.classList.remove('hidden');
      }
    });
  });
</script>
